# Spring beançš„ç”Ÿå‘½æµç¨‹

 Spring æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ J2EE å¼€æºæ¡†æž¶ï¼Œå…¶ç›®æ ‡æ˜¯é™ä½Žä¼ä¸šçº§åº”ç”¨å¼€å‘éš¾åº¦ï¼Œæé«˜ä¼ä¸šçº§åº”ç”¨å¼€å‘æ•ˆçŽ‡ã€‚åœ¨æ—¥ç¨‹å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ä½¿ç”¨ Spring æ¡†æž¶åŽ»æž„å»ºåº”ç”¨ã€‚æ‰€ä»¥ä½œä¸ºä¸€ä¸ªç»å¸¸ä½¿ç”¨çš„æ¡†æž¶ï¼Œäº†è§£å…¶åŽŸç†è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚æŽ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»Žå®è§‚å±‚é¢ä¸Šï¼Œæ¥çœ‹çœ‹ Spring ä¸­çš„ bean ç”±å®žä¾‹åŒ–åˆ°é”€æ¯çš„è¿‡ç¨‹ã€‚åœ¨è¯¦ç»†è®¨è®º bean ç”Ÿå‘½å‘¨æœŸå‰ï¼Œå…ˆä¸Šä¸€å¼ å›¾ï¼ŒåŽé¢ä¹Ÿä¼šå›´ç»•è¿™å¼ å›¾å±•å¼€è®¨è®ºã€‚ 

![1601002073520](Spring beançš„ç”Ÿå‘½æµç¨‹.assets/1601002073520.png)

å›¾1 beanå®žä¾‹åŒ–è¿‡ç¨‹

æŽ¥ä¸‹æ¥å¯¹ç…§ä¸Šå›¾ï¼Œä¸€æ­¥ä¸€æ­¥å¯¹ singleton ç±»åž‹ bean çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œè§£æžï¼š

1. å®žä¾‹åŒ– bean å¯¹è±¡ï¼Œç±»ä¼¼äºŽ new XXObject()
2. å°†é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„å±žæ€§å¡«å……åˆ°åˆšåˆšåˆ›å»ºçš„ bean å¯¹è±¡ä¸­ã€‚
3. æ£€æŸ¥ bean å¯¹è±¡æ˜¯å¦å®žçŽ°äº† Aware ä¸€ç±»çš„æŽ¥å£ï¼Œå¦‚æžœå®žçŽ°äº†åˆ™æŠŠç›¸åº”çš„ä¾èµ–è®¾ç½®åˆ° bean å¯¹è±¡ä¸­ã€‚æ¯”å¦‚å¦‚æžœ bean å®žçŽ°äº† BeanFactoryAware æŽ¥å£ï¼ŒSpring å®¹å™¨åœ¨å®žä¾‹åŒ–beançš„è¿‡ç¨‹ä¸­ï¼Œä¼šå°† BeanFactory å®¹å™¨æ³¨å…¥åˆ° bean ä¸­ã€‚
4. è°ƒç”¨ BeanPostProcessor å‰ç½®å¤„ç†æ–¹æ³•ï¼Œå³ postProcessBeforeInitialization(Object bean, String beanName)ã€‚
5. æ£€æŸ¥ bean å¯¹è±¡æ˜¯å¦å®žçŽ°äº† InitializingBean æŽ¥å£ï¼Œå¦‚æžœå®žçŽ°ï¼Œåˆ™è°ƒç”¨ afterPropertiesSet æ–¹æ³•ã€‚æˆ–è€…æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦é…ç½®äº† init-method å±žæ€§ï¼Œå¦‚æžœé…ç½®äº†ï¼Œåˆ™åŽ»è°ƒç”¨ init-method å±žæ€§é…ç½®çš„æ–¹æ³•ã€‚
6. è°ƒç”¨ BeanPostProcessor åŽç½®å¤„ç†æ–¹æ³•ï¼Œå³ postProcessAfterInitialization(Object bean, String beanName)ã€‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ AOP å°±æ˜¯åœ¨è¿™é‡Œå°† Adivce é€»è¾‘ç»‡å…¥åˆ° bean ä¸­çš„ã€‚
7. æ³¨å†Œ Destruction ç›¸å…³å›žè°ƒæ–¹æ³•ã€‚
8. bean å¯¹è±¡å¤„äºŽå°±ç»ªçŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨äº†ã€‚
9. åº”ç”¨ä¸Šä¸‹æ–‡è¢«é”€æ¯ï¼Œè°ƒç”¨æ³¨å†Œçš„ Destruction ç›¸å…³æ–¹æ³•ã€‚å¦‚æžœ bean å®žçŽ°äº† DispostbleBean æŽ¥å£ï¼ŒSpring å®¹å™¨ä¼šè°ƒç”¨ destroy æ–¹æ³•ã€‚å¦‚æžœåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº† destroy å±žæ€§ï¼ŒSpring å®¹å™¨åˆ™ä¼šè°ƒç”¨ destroy å±žæ€§å¯¹åº”çš„æ–¹æ³•ã€‚

ä¸Šè¿°æµç¨‹ä»Žå®è§‚ä¸Šå¯¹ Spring ä¸­ singleton ç±»åž‹ bean çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œäº†æè¿°ï¼ŒæŽ¥ä¸‹æ¥è¯´è¯´æ‰€ä¸Šé¢æµç¨‹ä¸­çš„ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚
å…ˆçœ‹æµç¨‹ä¸­çš„ç¬¬äºŒæ­¥ â€“ è®¾ç½®å¯¹è±¡å±žæ€§ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œå¯¹äºŽæ™®é€šç±»åž‹çš„å±žæ€§ï¼Œä¾‹å¦‚ Stringï¼ŒIntegerç­‰ï¼Œæ¯”è¾ƒå®¹æ˜“å¤„ç†ï¼Œç›´æŽ¥è®¾ç½®å³å¯ã€‚ä½†æ˜¯å¦‚æžœæŸä¸ª bean å¯¹è±¡ä¾èµ–å¦ä¸€ä¸ª bean å¯¹è±¡ï¼Œæ­¤æ—¶å°±ä¸èƒ½ç›´æŽ¥è®¾ç½®äº†ã€‚Spring å®¹å™¨é¦–å…ˆè¦å…ˆåŽ»å®žä¾‹åŒ– bean ä¾èµ–çš„å¯¹è±¡ï¼Œå®žä¾‹åŒ–å¥½åŽæ‰èƒ½è®¾ç½®åˆ°å½“å‰ bean ä¸­ã€‚å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š

![1601002178286](Spring beançš„ç”Ÿå‘½æµç¨‹.assets/1601002178286.png)

â€‹													å›¾2 ä¾èµ–å®žä¾‹åŒ–æµç¨‹å›¾

ä¸Šé¢å›¾ç‰‡æè¿°çš„ä¾èµ–æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ BeanA ä¾èµ– BeanBã€‚çŽ°åœ¨è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼ŒBeanA ä¾èµ– BeanBï¼ŒBeanB ä¾èµ– BeanCï¼ŒBeanC åˆä¾èµ– BeanAã€‚ä¸‰è€…å½¢æˆäº†å¾ªçŽ¯ä¾èµ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![1601002201533](Spring beançš„ç”Ÿå‘½æµç¨‹.assets/1601002201533.png)

â€‹																				å›¾3 å¾ªçŽ¯ä¾èµ–

å¯¹äºŽè¿™æ ·çš„å¾ªçŽ¯ä¾èµ–ï¼Œæ ¹æ®ä¾èµ–æ³¨å…¥æ–¹å¼çš„ä¸åŒï¼ŒSpring å¤„ç†æ–¹å¼ä¹Ÿä¸åŒã€‚å¦‚æžœä¾èµ–é æž„é€ å™¨æ–¹å¼æ³¨å…¥ï¼Œåˆ™æ— æ³•å¤„ç†ï¼ŒSpring ç›´æŽ¥ä¼šæŠ¥å¾ªçŽ¯ä¾èµ–å¼‚å¸¸ã€‚è¿™ä¸ªç†è§£èµ·æ¥ä¹Ÿä¸å¤æ‚ï¼Œæž„é€  BeanA æ—¶éœ€è¦ BeanB ä½œä¸ºæž„é€ å™¨å‚æ•°ï¼Œæ­¤æ—¶ Spring å®¹å™¨ä¼šå…ˆå®žä¾‹åŒ– BeanBã€‚æž„é€  BeanB æ—¶ï¼ŒBeanB åˆéœ€è¦ BeanC ä½œä¸ºæž„é€ å™¨å‚æ•°ï¼ŒSpring å®¹å™¨åˆä¸å¾—ä¸å…ˆåŽ»æž„é€  BeanCã€‚æœ€åŽæž„é€  BeanC æ—¶ï¼ŒBeanC åˆä¾èµ– BeanA æ‰èƒ½å®Œæˆæž„é€ ã€‚æ­¤æ—¶ï¼ŒBeanA è¿˜æ²¡æž„é€ å®Œæˆï¼ŒBeanA è¦ç­‰ BeanB å®žä¾‹åŒ–å¥½æ‰èƒ½å®Œæˆæž„é€ ï¼ŒBeanB åˆè¦ç­‰ BeanCï¼ŒBeanC ç­‰ BeanAã€‚è¿™æ ·å°±å½¢æˆäº†æ­»å¾ªçŽ¯ï¼Œæ‰€ä»¥å¯¹äºŽä»¥æž„é€ å™¨æ³¨å…¥æ–¹å¼çš„å¾ªçŽ¯ä¾èµ–æ˜¯æ— è§£çš„ï¼ŒSpring å®¹å™¨ä¼šç›´æŽ¥æŠ¥å¼‚å¸¸ã€‚å¯¹äºŽ setter ç±»åž‹æ³¨å…¥çš„å¾ªçŽ¯ä¾èµ–åˆ™å¯ä»¥é¡ºåˆ©å®Œæˆå®žä¾‹åŒ–å¹¶ä¾æ¬¡æ³¨å…¥ï¼Œè¿™é‡Œå…·ä½“ç»†èŠ‚å°±ä¸è¯´äº†ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒã€ŠSpringæºç æ·±åº¦è§£æžã€‹ä¸€ä¹¦ç›¸å…³ç« èŠ‚ã€‚

å¾ªçŽ¯ä¾èµ–é—®é¢˜è¯´å®Œï¼ŒæŽ¥ä¸‹æ¥ bean å®žä¾‹åŒ–æµç¨‹ä¸­çš„ç¬¬6æ­¥ â€“ è°ƒç”¨ BeanPostProcessor åŽç½®å¤„ç†æ–¹æ³•ã€‚å…ˆä»‹ç»ä¸€ä¸‹ BeanPostProcessor æŽ¥å£ï¼ŒBeanPostProcessor æŽ¥å£ä¸­åŒ…å«äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```java
public interface BeanPostProcessor {

    Object postProcessBeforeInitialization(Object bean, String beanName) throws Exception;

    Object postProcessAfterInitialization(Object bean, String beanName) throws Exception;
}
```

BeanPostProcessor æ˜¯ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æŽ¥å£ï¼Œé€šè¿‡å®žçŽ°æŽ¥å£æˆ‘ä»¬å°±å¯ä»¥æ’æ‰‹ bean çš„å®žä¾‹åŒ–è¿‡ç¨‹ï¼Œä¸ºæ‹“å±•æä¾›äº†å¯èƒ½ã€‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ AOP å°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œç»‡å¦‚å…¥ï¼Œå…·ä½“ç‚¹è¯´æ˜¯åœ¨ postProcessAfterInitialization(Object bean, String beanName) æ‰§è¡Œç»‡å…¥é€»è¾‘çš„ã€‚ä¸‹é¢å°±æ¥è¯´è¯´ Spring AOP ç»‡å…¥çš„æµç¨‹ï¼Œä»¥åŠ AOP æ˜¯æ€Žæ ·å’Œ IOC æ•´åˆçš„ã€‚å…ˆè¯´ Spring AOP ç»‡å…¥æµç¨‹ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š

1. æŸ¥æ‰¾å®žçŽ°äº† PointcutAdvisor ç±»åž‹çš„åˆ‡é¢ç±»ï¼Œåˆ‡é¢ç±»åŒ…å«äº† Pointcut å’Œ Advice å®žçŽ°ç±»å¯¹è±¡ã€‚
2. æ£€æŸ¥ Pointcut ä¸­çš„è¡¨è¾¾å¼æ˜¯å¦èƒ½åŒ¹é…å½“å‰ bean å¯¹è±¡ã€‚
3. å¦‚æžœåŒ¹é…åˆ°äº†ï¼Œè¡¨æ˜Žåº”è¯¥å¯¹æ­¤å¯¹è±¡ç»‡å…¥ Adviceã€‚
4. å°† beanï¼Œbean classå¯¹è±¡ï¼Œbeanå®žçŽ°çš„interfaceçš„æ•°ç»„ï¼ŒAdviceå¯¹è±¡ä¼ ç»™ä»£ç†å·¥åŽ‚ ProxyFactoryã€‚ä»£ç†å·¥åŽ‚åˆ›å»ºå‡º AopProxy å®žçŽ°ç±»ï¼Œæœ€åŽç”± AopProxy å®žçŽ°ç±»åˆ›å»º bean çš„ä»£ç†ç±»ï¼Œå¹¶å°†è¿™ä¸ªä»£ç†ç±»è¿”å›žã€‚æ­¤æ—¶ä»Ž postProcessAfterInitialization(Object bean, String beanName) è¿”å›žçš„ bean æ­¤æ—¶å°±ä¸æ˜¯åŽŸæ¥çš„ bean äº†ï¼Œè€Œæ˜¯ bean çš„ä»£ç†ç±»ã€‚åŽŸ bean å°±è¿™æ ·è¢«æ— æ„Ÿçš„æ›¿æ¢æŽ‰äº†ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å·å¤©æ¢æŸ±çš„æ„Ÿè§‰ã€‚

å¤§å®¶çŽ°åœ¨åº”è¯¥çŸ¥é“ AOP æ˜¯æ€Žæ ·ä½œç”¨åœ¨ bean ä¸Šçš„äº†ï¼Œé‚£ä¹ˆ AOP æ˜¯æ€Žæ ·å’Œ IOC æ•´åˆèµ·æ¥å¹¶ååŒå·¥ä½œçš„å‘¢ï¼Ÿä¸‹é¢å°±æ¥ç®€å•è¯´ä¸€ä¸‹ã€‚

Spring AOP ç”Ÿæˆä»£ç†ç±»çš„é€»è¾‘æ˜¯åœ¨ AbstractAutoProxyCreator ç›¸å…³å­ç±»ä¸­å®žçŽ°çš„ï¼Œæ¯”å¦‚ DefaultAdvisorAutoProxyCreatorã€AspectJAwareAdvisorAutoProxyCreator ç­‰ã€‚ä¸Šé¢è¯´äº† BeanPostProcessor ä¸ºæ‹“å±•ç•™ä¸‹äº†å¯èƒ½ï¼Œè¿™é‡Œ AbstractAutoProxyCreator å°±å°†å¯èƒ½å˜ä¸ºäº†çŽ°å®žã€‚AbstractAutoProxyCreator å®žçŽ°äº† BeanPostProcessor æŽ¥å£ï¼Œè¿™æ · AbstractAutoProxyCreator å¯ä»¥åœ¨ bean åˆå§‹åŒ–æ—¶åšä¸€äº›äº‹æƒ…ã€‚å…‰ç»§æ‰¿è¿™ä¸ªæŽ¥å£è¿˜ä¸å¤Ÿï¼Œç»§æ‰¿è¿™ä¸ªæŽ¥å£åªèƒ½èŽ·å– beanï¼Œè¦æƒ³è®© AOP ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦æ‹¿åˆ°åˆ‡é¢å¯¹è±¡ï¼ˆåŒ…å« Pointcut å’Œ Adviceï¼‰æ‰è¡Œã€‚æ‰€ä»¥ AbstractAutoProxyCreator åŒæ—¶ç»§æ‰¿äº† BeanFactoryAware æŽ¥å£ï¼Œé€šè¿‡å®žçŽ°è¯¥æŽ¥å£ï¼ŒAbstractAutoProxyCreator å­ç±»å°±å¯æ‹¿åˆ° BeanFactoryï¼Œæœ‰äº† BeanFactoryï¼Œå°±å¯ä»¥èŽ·å– BeanFactory ä¸­æ‰€æœ‰çš„åˆ‡é¢å¯¹è±¡äº†ã€‚æœ‰äº†ç›®æ ‡å¯¹è±¡ beanï¼Œæ‰€æœ‰çš„åˆ‡é¢ç±»ï¼Œæ­¤æ—¶å°±å¯ä»¥ä¸º bean ç”Ÿæˆä»£ç†å¯¹è±¡äº†ã€‚

![1601002417551](Spring beançš„ç”Ÿå‘½æµç¨‹.assets/1601002417551.png)

å›¾4 AbstractAutoProxyCreatorç»§æ‰¿å›¾ï¼ˆåˆ æŽ‰äº†ä¸€äº›ä¸å…³å¿ƒçš„ç»§æ‰¿åˆ†æ”¯ï¼‰

åˆ°è¿™é‡Œï¼Œä»Žå®è§‚ä¸Šå·²ç»å¯¹ bean çš„ç”Ÿå‘½æµç¨‹è¿›è¡Œäº†è¾ƒä¸ºè¯¦ç»†çš„æè¿°ã€‚ç”±äºŽæš‚æ—¶èƒ½åŠ›æœ‰é™ï¼Œåªèƒ½ä»Žå®è§‚ä¸Šåˆ†æžï¼Œä»¥å‰å°è¯•è¿‡åŽ»çœ‹ Spring IOC çš„å®žçŽ°ä»£ç ï¼Œæ„Ÿè§‰è¿˜æ˜¯å¤ªå¤æ‚äº†ï¼Œç»†èŠ‚å¤ªå¤šï¼Œè·Ÿè¸ªäº†åå‡ äºŒåä¸ªæ–¹æ³•åŽå°±å¼€å§‹å‡Œä¹±äº†ã€‚åœ¨å‡ æ¬¡å¤±è´¥çš„å°è¯•åŽï¼Œç»ˆäºŽæ”¾å¼ƒäº†ã€‚åŽæ¥æ€»ç»“äº†ä¸€ä¸‹å¤±è´¥çš„åŽŸå› ï¼Œå½“æ—¶è‡ªå·±åˆšå·¥ä½œä¸æ˜¯å¾ˆä¹…ï¼Œä»£ç å†™çš„å°‘ï¼Œç»éªŒä¸è¶³ã€‚å¹¶ä¸”åœ¨å¯¹ Spring å¾ˆå¤šç‰¹æ€§ä¸ç†Ÿæ‚‰çš„æƒ…å†µä¸‹å°±åŽ»çœ‹ Spring æºç ï¼Œç»“æžœåªèƒ½åˆ°å¤„ç¢°å£ï¼Œé™·å…¥ Spring å„ç§ç»†èŠ‚ä¹‹ä¸­ä¹…ä¹…ä¸èƒ½è‡ªæ‹”ðŸ˜‚ã€‚æ‰€ä»¥å¯¹äºŽæƒ³çœ‹æŸä¸ªæ¡†æž¶ä»£ç çš„åŒå­¦ï¼Œä¸€å®šè¦åœ¨ç†Ÿç»ƒä½¿ç”¨è¿™ä¸ªæ¡†æž¶çš„åŸºç¡€ä¸Šå†åŽ»çœ‹ã€‚ä¸è¦åƒæˆ‘è¿™æ ·æ€¥äºŽæ±‚æˆï¼Œä¸ç„¶åˆ°æœ€åŽåªèƒ½å¤±è´¥å•Šã€‚æœ¬äººè¿™ç¯‡åšå®¢å»ºç«‹åœ¨ä»¿å†™äº† Spring IOC å’Œ AOPçš„åŸºç¡€ä¸Šå†™å‡ºæ¥çš„ï¼Œåœ¨ä»¿å†™è¿‡ç¨‹ä¸­å‚è€ƒäº†é»„äº¿åŽå‰è¾ˆçš„ [tiny-spring](https://github.com/code4craft/tiny-spring) é¡¹ç›®ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¯»è¯» tiny-springã€‚æˆ‘è‡ªå·±ä»¿å†™çš„é¡¹ç›®ä¹Ÿæ”¾åœ¨äº†githubä¸Šï¼Œä¼ é€é—¨ --> [toy-spring](https://github.com/code4wt/toy-spring)ã€‚